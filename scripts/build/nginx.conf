server
{
    server_name s.unsee.cc.local;
    root        /var/www/umkus/unsee/static/;
    include     nginx-bp/bootstrap/static.conf;
}

server
{
    server_name unsee.cc.local;
    root        /var/www/umkus/unsee/public/;

    include     nginx-bp/bootstrap/default.conf;

    ########## Your custom locations & settings ##########

    include     nginx-bp/enable/uploads.conf;

    #Rewrite request to image view controller
    rewrite ^/(?<hash>(?:[stnmrgzdbp][aeiou])+)/$  /view/index/hash/$hash/;

    #Rewrite request to image content output controller
    rewrite ^/image/(?<imgId>[a-z0-9]+)/(?<ticket>[\w\-]+)/(?<time>[0-9]+)/?$  /view/image/id/$imgId/ticket/$ticket/time/$time;

    # Handle the image request
    location ~ ^/view/image/id/(?<imgId>\w+)/ticket/(?<ticket>[\w\-]+)/time/(?<time>[0-9]+)/?$
    {
        internal;

        # Fetch 1 image at a time
        limit_req               zone=reqPerSec1 burst=100;

        secure_link     $ticket,$time;
        secure_link_md5 $imgId$time;

        if ($secure_link = "") {
            return 444;
        }

        if ($secure_link = "0") {
            return 444;
        }

        include     nginx-bp/enable/php.conf;
    }
}
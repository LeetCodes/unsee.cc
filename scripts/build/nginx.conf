pagespeed on;
pagespeed FileCachePath              "/tmp/pagespeed/";
pagespeed EnableFilters combine_css;
pagespeed EnableFilters combine_javascript;
pagespeed EnableFilters rewrite_javascript;

server
{
    server_name s.unsee.cc.local;
    root        /var/www/umkus/unsee/public/static/;
    include     nginx-bp/bootstrap/static.conf;
}

server
{

    #  Ensure requests for pagespeed optimized resources go to the pagespeed
    #  handler and no extraneous headers get set.
    location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" { add_header "" ""; }
    location ~ "^/ngx_pagespeed_static/" { }
    location ~ "^/ngx_pagespeed_beacon$" { }
    location /ngx_pagespeed_statistics { allow 127.0.0.1; deny all; }
    location /ngx_pagespeed_global_statistics { allow 127.0.0.1; deny all; }
    location /ngx_pagespeed_message { allow 127.0.0.1; deny all; }
    location /pagespeed_console { allow 127.0.0.1; deny all; }

    pagespeed MapRewriteDomain s.unsee.cc.local *.unsee.cc.local;

    server_name unsee.cc.local;
    root        /var/www/umkus/unsee/public/;

    include     nginx-bp/bootstrap/default.conf;

    ########## Your custom locations & settings ##########

    include     nginx-bp/enable/uploads.conf;

    #Rewrite request to image view controller
    rewrite ^/(?<hash>(?:[stnmrgzdbp][aeiou])+)/$  /view/index/hash/$hash/;

    #Rewrite request to image content output controller
    rewrite ^/image/(?<imgId>[a-z0-9]+)/(?<ticket>[\w\-]+)/(?<time>[0-9]+)/?$  /view/image/id/$imgId/ticket/$ticket/time/$time;

    # Handle the image request
    location ~ ^/view/image/id/(?<imgId>\w+)/ticket/(?<ticket>[\w\-]+)/time/(?<time>[0-9]+)/?$
    {
        internal;
        secure_link     $ticket,$time;
        secure_link_md5 $imgId$time;

        if ($secure_link = "") {
            return 444;
        }

        if ($secure_link = "0") {
            return 444;
        }

        include     nginx-bp/enable/php.conf;
    }
}